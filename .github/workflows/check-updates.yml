name: Check for Tool Updates

on:
    schedule:
        - cron: "0 0 * * *" # Daily at midnight UTC
    workflow_dispatch: # Manual trigger

jobs:
    check-updates:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write
            actions: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Check for updates
              id: check
              run: |
                  # Read current registry
                  UPDATES_FOUND=false

                  # For each tool in registry
                  for row in $(jq -r '.tools[] | @base64' public/registry/registry.json); do
                    _jq() {
                      echo ${row} | base64 --decode | jq -r "${1}"
                    }
                    
                    TOOL_ID=$(_jq '.id')
                    CURRENT_VERSION=$(_jq '.version')
                    NPM_PACKAGE=$(_jq '.packageName // .id')
                    
                    # Get latest npm version
                    LATEST_VERSION=$(npm view $NPM_PACKAGE version 2>/dev/null || echo "")
                    
                    if [ -z "$LATEST_VERSION" ]; then
                      echo "âš ï¸ Could not fetch version for $TOOL_ID"
                      continue
                    fi
                    
                    # Compare versions
                    if [ "$LATEST_VERSION" != "$CURRENT_VERSION" ]; then
                      echo "ðŸ”„ Update available for $TOOL_ID: $CURRENT_VERSION â†’ $LATEST_VERSION"
                      echo "$TOOL_ID,$CURRENT_VERSION,$LATEST_VERSION" >> updates.txt
                      UPDATES_FOUND=true
                    fi
                  done

                  echo "found=$UPDATES_FOUND" >> $GITHUB_OUTPUT

            - name: Run Update Workflow
              if: steps.check.outputs.found == 'true'
              run: |
                  # Configure git
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  # Process each update
                  while IFS=',' read -r NPM_PACKAGE CURRENT LATEST; do
                    echo "Processing update: $NPM_PACKAGE $CURRENT â†’ $LATEST"
                    
                    # Trigger conversion workflow and capture the workflow run
                    # Pass the branch name so the workflow commits to the correct branch
                    gh workflow run update-convert-tool.yml \
                      -f tool_id="$NPM_PACKAGE" \
                      -f version="$LATEST" \
                      -f branch="$BRANCH_NAME"
                    
                    # Wait a moment for the workflow to start
                    sleep 10
                    
                  done < updates.txt

              env:
                  GH_TOKEN: ${{ github.token }}
