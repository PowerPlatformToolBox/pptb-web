name: Check for Tool Updates

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:  # Manual trigger

jobs:
  check-updates:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Check for updates
        id: check
        run: |
          # Read current registry
          UPDATES_FOUND=false
          
          # For each tool in registry
          for row in $(jq -r '.tools[] | @base64' public/registry/registry.json); do
            _jq() {
              echo ${row} | base64 --decode | jq -r "${1}"
            }
            
            TOOL_ID=$(_jq '.id')
            CURRENT_VERSION=$(_jq '.version')
            NPM_PACKAGE=$(_jq '.packageName // .id')
            
            # Get latest npm version
            LATEST_VERSION=$(npm view $NPM_PACKAGE version 2>/dev/null || echo "")
            
            if [ -z "$LATEST_VERSION" ]; then
              echo "âš ï¸ Could not fetch version for $TOOL_ID"
              continue
            fi
            
            # Compare versions
            if [ "$LATEST_VERSION" != "$CURRENT_VERSION" ]; then
              echo "ðŸ”„ Update available for $TOOL_ID: $CURRENT_VERSION â†’ $LATEST_VERSION"
              echo "$TOOL_ID,$CURRENT_VERSION,$LATEST_VERSION" >> updates.txt
              UPDATES_FOUND=true
            fi
          done
          
          echo "found=$UPDATES_FOUND" >> $GITHUB_OUTPUT
      
      - name: Create update PR
        if: steps.check.outputs.found == 'true'
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create new branch
          BRANCH_NAME="updates-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME
          
          # Create a placeholder commit to establish the branch
          echo "# Tool Updates - $(date +%Y-%m-%d)" > .update-tracker.md
          git add .update-tracker.md
          git commit -m "Track updates for $(date +%Y-%m-%d)"
          
          # Push the branch
          git push -u origin $BRANCH_NAME
          
          # Process each update
          while IFS=',' read -r TOOL_ID CURRENT LATEST; do
            echo "Processing update: $TOOL_ID $CURRENT â†’ $LATEST"
            
            # Trigger conversion workflow via repository dispatch
            # This will handle download, build, and registry update
            gh workflow run update-convert-tool.yml \
              -f tool_id="$TOOL_ID" \
              -f version="$LATEST"
            
          done < updates.txt
          
          # Create PR
          gh pr create \
            --title "Tool Updates - $(date +%Y-%m-%d)" \
            --body "Automated tool updates detected" \
            --label "automated-update"
        env:
          GH_TOKEN: ${{ github.token }}