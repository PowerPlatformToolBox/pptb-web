name: Check for Tool Updates

on:
    schedule:
        - cron: "0 0 * * *" # Daily at midnight UTC
    workflow_dispatch: # Manual trigger

jobs:
    check-updates:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write
            actions: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Check for updates
              id: check
              env:
                  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
                  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
              run: |
                  UPDATES_FOUND=false

                  # Fetch tools from Supabase
                  HTTP_CODE=$(curl -s -w "%{http_code}" -o /tmp/tools_response.json "$SUPABASE_URL/rest/v1/tools?select=packagename,version" \
                    -H "apikey: $SUPABASE_ANON_KEY" \
                    -H "Authorization: Bearer $SUPABASE_ANON_KEY")
                  TOOLS_RESPONSE=$(cat /tmp/tools_response.json)

                  # Check HTTP status code
                  if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
                    echo "âŒ Failed to fetch tools from Supabase (HTTP $HTTP_CODE)"
                    echo "Response: $TOOLS_RESPONSE"
                    exit 1
                  fi

                  # Check if response is valid JSON array
                  if ! echo "$TOOLS_RESPONSE" | jq -e 'type == "array"' > /dev/null 2>&1; then
                    echo "âŒ Invalid response from Supabase - expected JSON array"
                    echo "Response: $TOOLS_RESPONSE"
                    exit 1
                  fi

                  # For each tool in Supabase
                  for row in $(echo "$TOOLS_RESPONSE" | jq -r '.[] | @base64'); do
                    _jq() {
                      echo ${row} | base64 --decode | jq -r "${1}"
                    }

                    NPM_PACKAGE=$(_jq '.packagename')
                    CURRENT_VERSION=$(_jq '.version')

                    # Skip if packagename is null or empty
                    if [ -z "$NPM_PACKAGE" ] || [ "$NPM_PACKAGE" = "null" ]; then
                      continue
                    fi

                    # Get latest npm version
                    LATEST_VERSION=$(npm view $NPM_PACKAGE version 2>/dev/null || echo "")

                    if [ -z "$LATEST_VERSION" ]; then
                      echo "âš ï¸ Could not fetch version for $NPM_PACKAGE"
                      continue
                    fi

                    # Compare versions
                    if [ "$LATEST_VERSION" != "$CURRENT_VERSION" ]; then
                      echo "ðŸ”„ Update available for $NPM_PACKAGE: $CURRENT_VERSION â†’ $LATEST_VERSION"
                      echo "$NPM_PACKAGE,$CURRENT_VERSION,$LATEST_VERSION" >> updates.txt
                      UPDATES_FOUND=true
                    fi
                  done

                  echo "found=$UPDATES_FOUND" >> $GITHUB_OUTPUT

            - name: Invoke NextJS Update Tool API
              if: steps.check.outputs.found == 'true'
              run: |
                  while IFS=',' read -r PACKAGE CURRENT_VERSION LATEST_VERSION; do
                    curl -X POST https://powerplatformtoolbox.com/app/api/updateTool \
                      -H "Content-Type: application/json" \
                      -d "{\"packageName\":\"$PACKAGE\",\"currentVersion\":\"$CURRENT_VERSION\",\"latestVersion\":\"$LATEST_VERSION\"}"
                  done < updates.txt
